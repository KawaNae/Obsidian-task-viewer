## 記法

基本構成として`@start>end>deadline`という構成をとる
start、end、deadlineはYYYY-MM-DDの形式で指定する
具体的には以下の7パターンで使用できる
```markdown
- [ ] @2001-11-11>2001-11-12>2001-11-13 <!--完全な記法(SED型)-->

- [ ] @2001-11-11>2001-11-12 <!--締め切りの省略(SE型)-->
- [ ] @2001-11-11>>2001-11-13 <!--終了の省略(SD型)-->
- [ ] @>2001-11-12>2001-11-13 <!--開始の省略、開始の省略は今日の開始だとみなす(ED型)-->

- [ ] @2001-11-11 <!--開始のみの指定(S-All型)-->
- [ ] @>2001-11-12 <!--終了のみの指定、開始は今日であるとみなす(E型)-->
- [ ] @>>2001-11-13 <!--締め切りのみの指定、開始は今日であるとみなす(D型)-->
```

さらに時刻を指定する場合はYYYY-MM-DDTHH:mmまたはHH:mmの形式で指定する。日付を省略できる場合はなるべく省略することを推奨する
```markdown
- [ ] @2001-11-11T12:00 <!--開始のみの指定(S-Timed型)-->
- [ ] @2001-11-11T12:00>13:00 <!--終了の日付を省略した場合は開始の日付と同一だと扱う-->
- [ ] @2001-11-11T12:00>2001-11-12T12:00 <!--終了の日付を書いても良い-->
- [ ] @2001-11-11T12:00>12:00>2001-11-13T12:00 <!--締め切りの日付は省略しない-->
- [ ] @2001-11-11T12:00>2001-11-12T12:00>2001-11-13T12:00 <!--時刻を含めて完全な記法(SED)-->
```

startについては、開始日が未定であることの表現として`future`を用意する
```markdown
- [ ] @future <!--いつでもできるタスク(F型)--> 
```

ただし以下のような使い方は`future`は開始日の省略だと解釈する
```markdown
- [ ] @future>>2001-11-13 <!--D型と同じ扱い-->
- [ ] @future>2001-11-12 <!--E型と同じ扱い-->
- [ ] @future>2001-11-12>2001-11-13 <!--ED型と同じ扱い-->
```

### 子タスクの扱い

@記法による日付時刻指定を持つタスクは、親タスクとして独立したタスクカードを生成する。子タスク（インデントされた行）は親タスクのカード内に表示される。

#### 基本ルール

1. **独立したカード生成**: @記法を持つタスクはすべて独立したタスクカードを生成する
2. **子タスクの包含表示**: 親タスクのカードにはその下にインデントされた全ての行（子タスク、孫タスク等）を表示する
3. **再帰的処理**: @記法を持つ子タスクも独立したカードを生成し、その下のインデント行を子として持つ
4. **型決定の独立性**: 各タスクの型（SED, SE等）は自身の@記法のみで決定し、親や子の@記法は影響しない

#### 例

```markdown
- [ ] parent-task @2026-01-05
    - [ ] child-task1 @2026-01-06
        - [ ] grand-child-task @2026-01-07
            - [ ] great-grand-child-task
    - [ ] child-task2 @2026-01-08
        - [ ] grand-child-task
    - [ ] child-task3
```

上記のタスク構造から、以下の4つのタスクカードが生成される：

| タスク | 日付 | カード内に表示される子タスク |
|--------|------|------------------------------|
| parent-task | 2026-01-05 | child-task1, grand-child-task, great-grand-child-task, child-task2, grand-child-task, child-task3 |
| child-task1 | 2026-01-06 | grand-child-task, great-grand-child-task |
| grand-child-task | 2026-01-07 | great-grand-child-task |
| child-task2 | 2026-01-08 | grand-child-task |

#### 子タスクのインデント正規化

タスクカード内に表示される子タスクは、元のファイルでのインデントから親タスクのインデント分を除去して表示する。これにより、カード内では常にルートからの相対インデントで表示される。



## コマンド

タスクを完了（`[ ]`→`[x]`）したときに自動実行されるコマンドを`==>`の後に記述する。

### 基本構文
```markdown
- [ ] タスク名 @日付 ==> コマンド名(引数)
```

### 利用可能なコマンド

#### next(期間)
タスク完了時に、**コマンドを削除した新しいタスク**を生成する。日付は指定期間分シフトする。

```markdown
- [ ] 週次レビュー @2026-01-01 ==> next(1week)
# 完了後:
- [x] 週次レビュー @2026-01-01 ==> next(1week)
- [ ] 週次レビュー @2026-01-08
```

#### repeat(期間)  
タスク完了時に、**コマンドを維持した新しいタスク**を生成する。繰り返しパターンに最適。

```markdown
- [ ] 毎日の振り返り @2026-01-01 ==> repeat(1day)
# 完了後:
- [x] 毎日の振り返り @2026-01-01 ==> repeat(1day)
- [ ] 毎日の振り返り @2026-01-02 ==> repeat(1day)
```

#### move(ファイルパス)
タスク完了時に、タスク行を指定したファイルに移動する。

```markdown
- [ ] 完了したらログへ @2026-01-01 ==> move([[log.md]])
```

### 期間の指定方法
| 記法 | 意味 |
|-----|-----|
| `1day` / `1days` | 1日 |
| `1week` / `1weeks` | 1週間（7日） |
| `1month` / `1months` | 1ヶ月 |
| `1year` / `1years` | 1年 |

### タスク型ごとの日付シフト動作

コマンドは7つのタスク型すべてに対応しており、それぞれの型に応じて適切な日付がシフトされる。

| タスク型 | シフト対象 | 例（+1day） |
|---------|----------|------------|
| SED型 | start, end, deadline | `@01-01>01-02>01-03` → `@01-02>01-03>01-04` |
| SE型 | start, end | `@01-01>01-02` → `@01-02>01-03` |
| SD型 | start, deadline | `@01-01>>01-03` → `@01-02>>01-04` |
| ED型 | end, deadline | `@>01-02>01-03` → `@>01-03>01-04` |
| S-All/S-Timed型 | start（時刻維持） | `@01-01T10:00` → `@01-02T10:00` |
| E型 | end（時刻維持） | `@>01-02T15:00` → `@>01-03T15:00` |
| D型 | deadline（時刻維持） | `@>>01-03T17:00` → `@>>01-04T17:00` |
| F型 | 変更なし | `@future` → `@future` |

## 同期検出（Sync Detection）

複数デバイス間でObsidianを同期している場合（obsidian-self-hosted-livesyncなど）、タスク完了時に他のデバイスでコマンドが重複実行されるのを防ぐ仕組み。

### 検出メカニズム

プラグインは以下の2つの方法でローカル操作を検出する。

1. **アクティブエディタの入力イベント監視**
   - ユーザーがエディタで直接入力した場合、`beforeinput`/`input`イベントを検出
   - 該当ファイルを「ローカル編集中」としてマーク

2. **プラグインUI経由の操作**
   - タイムラインビューでのタスク完了、ドラッグ操作など
   - プラグイン内部で明示的に「ローカル編集」としてマーク

これらのマークがない状態で`vault.modify`イベントが発火した場合、同期による変更と判定する。

### 動作

| 変更の種類 | コマンド実行 |
|-----------|------------|
| ローカル操作（直接編集・タイムラインビュー操作） | ✓ 実行 |
| 同期による変更 | ✗ スキップ |

これにより、タスクを完了したデバイスでのみコマンドが実行され、同期先のデバイスでは重複実行されない。

### 制限事項

> [!NOTE]
> 複数デバイスで**同時に**同じファイルを操作した場合、誤検出が発生する可能性があります。
> 通常の使用（片方のデバイスで操作し、他方は同期を受け取るのみ）では問題ありません。

### テスト用
```markdown
- [ ] SED型タスク @2026-01-01>2026-01-03>2026-01-05
- [ ] SE型タスク @2026-01-01>2026-01-03
- [ ] SD型タスク @2026-01-01>>2026-01-05
- [ ] ED型タスク @>2026-01-03>2026-01-05
- [ ] S-All型タスク @2026-01-01
- [ ] E型タスク @>2026-01-03
- [ ] D型タスク @>>2026-01-05
- [ ] F型タスク @future

- [ ] SED型タスク（時刻あり） @2026-01-01T10:00>2026-01-01T15:00>2026-01-02T17:00
- [ ] SE型タスク（時刻あり） @2026-01-01T09:00>12:00
- [ ] S-Timed型タスク @2026-01-01T14:00

- [ ] SE型長期タスク @2026-01-01T10:00>2026-01-03T10:00
- [ ] SED型長期タスク @2026-01-01>2026-01-04>2026-01-07
```

### 期間の計算
タスクの期間は、設定された開始時刻基準を基準として：
1. SED、SE型：startからendまでの実際の時間を計算
2. SD、S-All型：start日の開始時刻から開始時刻+23:59まで（1日=24時間）
3. S-Timed型：start時刻から+1時間（常に1時間=タイムライン表示）
4. E、ED型：ビューの左端の日付の開始時刻をstartとみなす
5. D型：ビューの左端の日付の開始時刻をstart、start+23:59をendとみなす

### 24時間境界の扱い
- 期間が24時間以上（>=24:00）→長期タスク欄
- 期間が24時間未満（<24:00）→タイムライン欄
- 24時間ちょうど（例：12:00-12:00翌日）→長期タスク欄

### タスク配置ルール一覧表

| タスク型 | 時刻の有無 | 期間 | 配置先 |
|---------|-----------|------|--------|
| F | - | - | 未割当欄 |
| SED/SE | あり | >=24h | 長期タスク欄 |
| SED/SE | あり | <24h | タイムライン欄 |
| SED/SE | なし | >=24h | 長期タスク欄 |
| SD/S-All/ED/E/D | - | 常に>=24h | 長期タスク欄 |
| S-Timed | あり | 常に1h | タイムライン欄 |

## タイムラインビュー

タイムラインビューには以下の4つの欄を持つ
1. 未割当タスク欄
2. 日付欄
3. 長期タスク欄
4. タイムライン

またタイムラインビューではタスクの完了、移動ハンドルによるタスクカードの移動、伸縮ハンドルによるタスクのstartとendの更新、右クリックか長押しによるコンテキストメニューの呼び出しができる。UI操作は"UI:操作内容"、コンテキストメニューの内容は"C:操作内容"と表記する。

すべての欄において以下の操作を受け付ける
- UI:タスクの完了
    タスクの状態をdone([ ]=>[x])にする
- C:Delete
    このタスク行をmarkdownファイルから削除
- C:Duplicate
    このタスク行をmarkdownファイルに複製する
- C:Open
    タスクが書かれているmarkdownファイルを開く
- C:パラメータの表示（コンテキストメニュー内に表示する）
    start、end、deadlineの値を表示する。自動設定された値は括弧付きで表示する

### 未割当タスク欄/Future
未割当タスク欄は以下のようなタスクを表示する
- すべてのF型のタスク

F型は以下の操作を受け付ける
- C:Move to All day/UI:移動ハンドルによる未割当タスク欄への移動
    S-All型に変換する。startに今日の日付を追加する。移動ハンドルの場合はUIで指定する
- C:Move to Timeline/UI:移動ハンドルによるタイムライン欄への移動
    S-timed型に変換する。startに今日の日付の時刻を追加する。移動ハンドルの場合はUIで指定する


### 日付欄
日付欄は日付をyyyy-mm-dd(ddd)の形式で表示し、日付をクリックするとdaily noteを開く。ここでの日付は設定によって決められる日付（設定された開始時刻から24時間を一日と扱う）であり、実際の日付とは異なる。

例えば設定では05:00を開始時刻として設定している場合、@2001-11-11T05:00は2001-11-11のタスクだが、@2001-11-11T04:00は2001-11-10のタスクとなる。


### 終日タスク欄/All Day
終日タスク欄は以下のタスクを表示する
- SED型のうち24時間以上の期間を持つタスク
- SE型のうち24時間以上の期間を持つタスク
- SD型のタスク
- ED型のタスク
- E型のタスク
- D型のタスク
- S-All型のタスク

#### SED型のうち24時間以上の期間を持つタスク
このタイプのタスクは以下の操作を受け付ける
- UI:移動ハンドル操作
    startとendの日付の更新(期間が変化しない)
- UI:伸縮ハンドル操作
    右端伸縮: endの日付を更新する。deadlineは変更しない
    左端伸縮: startの日付を更新する 。deadlineは変更しない

#### SE型のうち24時間以上の期間を持つタスク
このタイプのタスクは以下の操作を受け付ける
- UI:移動ハンドル操作
    startとendの日付の更新(期間が変化しない)
- UI:伸縮ハンドル操作
    右端伸縮: endの日付を更新する。
    左端伸縮: startの日付を更新する。
- C:Move to Future/UI:移動ハンドルによる未割当タスク欄への移動
    F型に変換する。 start全体を`future`に置き換え、end全体を削除する

#### SD型のタスク
このタイプのタスクは以下の操作を受け付ける
- UI:移動ハンドル操作
    startの日付の更新、endの日付を与えてSED型に変換する。移動前と移動後で幅が変化しないようにstartとendの日付を計算し、deadlineは変更しない
- UI:伸縮ハンドル操作
    - 右端伸縮: endの日付を与えてSED型に変換する。deadlineは変更しない    
    - 左端伸縮: startの日付の更新(期間が変化する)。deadlineは変更しない    
    

#### ED型のタスク
このタイプのタスクは以下の操作を受け付ける
- UI:移動ハンドル操作
    endの日付の更新、startの日付を与えてSED型に変換する。移動前と移動後で幅が変化しないようにstartとendの日付を計算し、deadlineは変更しない
- UI:伸縮ハンドル操作
    - 右端伸縮: endの日付の更新(期間が変化する)。deadlineは変更しない
    - 左端伸縮: startの日付を与えてSED型に変換する。deadlineは変更しない

#### E型のタスク
このタイプのタスクは以下の操作を受け付ける
- UI:移動ハンドル操作
    endの日付の更新、startの日付を与えてSE型に変換する。移動前と移動後で幅が変化しないようにstartとendの日付を計算する
- UI:伸縮ハンドル操作
    - 右端伸縮: endの日付の更新(期間が変化する)
    - 左端伸縮: startの日付を与えてSE型に変換する。
- C:Move to Future/UI:移動ハンドルによる未割当タスク欄への移動
    F型に変換する。 start全体を`future`に置き換え、end全体を削除する

#### D型のタスク
このタイプのタスクは以下の操作を受け付ける
- UI:移動ハンドル操作
    startを与えてS-All型に変換する。deadlineは変更しない
- UI:伸縮ハンドル操作
    - 右端伸縮: endの日付を追加して ED型に変換。deadlineは変更しない
    - 左端伸縮: startの日付を追加して SD型に変換。deadlineは変更しない


#### S-All型のタスク
このタイプのタスクは以下の操作を受け付ける
- UI:伸縮ハンドル操作
    - 右端伸縮: endの日付を追加して SE型に変換
    - 左端伸縮: startの日付を更新（S-All型のまま、期間は1日で一定）
- UI:移動ハンドル操作
    startの日付の更新(期間が変化しない)
- C:Move to Timeline`/UI:移動ハンドルによるタイムライン欄への移動
    S-timed型に変換する。startに時刻を追加し、追加する時刻はタイムライン上で指定する。
- C:Move to Future/UI:移動ハンドルによる未割当タスク欄への移動
    F型に変換する。start全体を`future`に置き換える

### タイムライン欄/Timeline
タイムライン欄は以下の3種類のタスクを表示する。それぞれタイムライン上を動かすことで移動と伸縮などが可能であり、それに従ってstartとendが更新される。deadlineがある場合ははそのまま保持される。タイプに関わらず以下の操作を受け付ける
- UI:伸縮ハンドル操作
    上端伸縮: start時刻と日付の更新(期間が変化する)、deadlineは変更しない
    下端伸縮: end時刻と日付の更新(期間が変化する)、deadlineは変更しない
- UI:移動ハンドル操作
    startとendの時刻と日付の更新(期間が変化しない)

#### SED型のうち24時間未満の期間を持つタスク（24時間未満ということは時刻を持っている）
このタイプは追加で以下の操作を受け付ける
- C:Move to All Day/UI:移動ハンドルによる終日タスク欄への移動
    D型に変換する。start全体とend全体を削除する（deadlineが残る）

#### SE型のうち24時間未満の期間を持つタスク（24時間未満ということは時刻を持っている）
このタイプは追加で以下の操作を受け付ける
- C:Move to Future/UI:移動ハンドルによる未割当タスク欄への移動
    F型に変換する。 start全体を`future`に置き換え、end全体を削除する
- C:Move to All Day/UI:移動ハンドルによる終日タスク欄への移動
    S-All型に変換する。startの時刻とend全体を削除する

#### S-Timed型のタスク
このタイプは追加で以下の操作を受け付ける
- C:Move to Future/UI:移動ハンドルによる未割当タスク欄への移動
    F型に変換する。start全体を`future`に置き換える
- C:Move to All Day/UI:移動ハンドルによる終日タスク欄への移動
    S-All型に変換する。startの時刻を削除する


## UI操作
タスクの移動については、未割当タスク欄(FU)、長期タスク欄(LT)、タイムライン(TL)の間を行き来する。
移動は以下のいずれかを行う。
- FU->LT
ドラッグ&ドロップでタスクカードを持ち、浮遊タスクカードになる。浮遊タスクカードはマウスに追従してLTエリアに移動できる。LTエリアはその日の欄全体がハイライトされる。どの日にドロップするかで、S-All型またに変換する。
- FU->TL
ドラッグ&ドロップでタスクカードを持ち、浮遊タスクカードになる。浮遊タスクカードはマウスに追従してTLエリアに移動できる。TLエリアのどこにドロップするかでstartを指定してS-Timed型に変換する。

- AD->TL
ドラッグ&ドロップでタスクカードを持ち、浮遊タスクカードになる。浮遊タスクカードはマウスに追従してTLエリアに移動できる。TLエリアのどこにドロップするかでstartを指定してS-Timed型に変換する。このときend全体は削除し、deadlineがある場合はSD型にする

- AD->FU
ドラッグ&ドロップでタスクカードを持ち、浮遊タスクカードになる。浮遊タスクカードはマウスに追従してFUエリアに移動できる。deadlineがある場合はこの操作を許容しない。startを`future`に置き換えて、end全体を削除する。

- TL->FU
ドラッグ&ドロップでタスクカードを持ち、浮遊タスクカードになる。浮遊タスクカードはマウスに追従してFUエリアに移動できる。deadlineがある場合はこの操作を許容しない。startを`future`に置き換えて、end全体を削除する。

- TL->AD
この操作は後述する自動スクロールと競合するため実装しない

## 自動スクロール
タイムライン欄の移動ハンドル、伸縮ハンドルでの動作に置いて、移動、伸縮中にマウスがタイムラインの表示領域の外に出た場合は自動的にスクロールする。タスクカードは自動スクロールに従ってマウスに追従する

## CSS命名規則

本プロジェクトでは[BEM（Block Element Modifier）](https://getbem.com/)命名規則に従ってCSSクラス名を命名している。

### 基本構造
```
.block                  /* ブロック: 独立したコンポーネント */
.block__element         /* 要素: ブロックの一部 */
.block--modifier        /* 修飾子: バリエーション・状態 */
.block__element--modifier
```

### 例
```css
.task-card              /* ブロック: タスクカード */
.task-card__content     /* 要素: タスクカードのコンテンツ部分 */
.task-card__time        /* 要素: 時刻表示部分 */
.task-card__handle      /* 要素: ハンドルコンテナ */
.task-card__handle-btn  /* 要素: ハンドルボタン */
.task-card--allday      /* 修飾子: 終日タスク */
.task-card--future      /* 修飾子: 未割当タスク */
.task-card--multi-day   /* 修飾子: 複数日タスク */
.task-card__handle--move        /* 要素+修飾子: 移動ハンドル */
.task-card__handle--resize-top  /* 要素+修飾子: 上端リサイズハンドル */
```

### CSSファイル構造
```
src/styles/
├── _variables.css          # CSS変数定義
├── _base.css               # グローバルスタイル
├── _task-card.css          # タスクカードコンポーネント
├── _checkboxes.css         # チェックボックスアイコン
├── _timeline-grid.css      # タイムライングリッド
├── _timeline-date-header.css # 日付ヘッダー
├── _timeline-allday.css    # 終日タスク欄
├── _timeline-future.css    # 未割当タスク欄
├── _timeline-drag.css      # ドラッグ関連スタイル
├── _kanban.css             # カンバンビュー
├── _schedule.css           # スケジュールビュー
└── _deprecated.css         # 非推奨・未使用スタイル（検証用）
```